<style>
  body {
    background: url({{ (resources.Get "background/background.png").Permalink }}) no-repeat center top;
    background-size: cover;
    background-attachment: fixed;
  }
</style>

<div id="particles-js"></div>

<script src={{ (resources.Get "background/particles.min.js").Permalink }}></script>
<script>
  particlesJS.load('particles-js', {{ (resources.Get "background/particlesjs-config.json").Permalink }}, function() {
    console.log('particles.js loaded - callback');
  });
</script>

<style>
  #particles-js {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    z-index: -1;
  }
</style>


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css">
<div id="aplayer"></div>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script>
<!-- ã€custom.htmlã€‘ -->
<script>
    // è·å–åšå®¢æœ¬åœ°èµ„æºåœ°å€
    const cssPath = {{ (resources.Get "waifu/waifu.css").Permalink }}
    const tipsJsonPath = {{ (resources.Get "waifu/waifu-tips.json").Permalink }}
    // live2d_path å‚æ•°å»ºè®®ä½¿ç”¨ç»å¯¹è·¯å¾„
    const live2d_path = "https://fastly.jsdelivr.net/gh/stevenjoezhang/live2d-widget@latest/";

    // å°è£…å¼‚æ­¥åŠ è½½èµ„æºçš„æ–¹æ³•
    function loadExternalResource(url, type) {
        return new Promise((resolve, reject) => {
            let tag;
            if (type === "css") {
                tag = document.createElement("link");
                tag.rel = "stylesheet";
                tag.href = url;
            }
            else if (type === "js") {
                tag = document.createElement("script");
                tag.src = url;
            }
            if (tag) {
                tag.onload = () => resolve(url);
                tag.onerror = () => reject(url);
                document.head.appendChild(tag);
            }
        });
    }

    // åŠ è½½ waifu.css live2d.min.js waifu-tips.js
    if (screen.width >= 768) {
        Promise.all([
            loadExternalResource(cssPath, "css"),
            loadExternalResource(live2d_path + "live2d.min.js", "js"),
            loadExternalResource(live2d_path + "waifu-tips.js", "js")
        ]).then(() => {
            // é…ç½®é€‰é¡¹çš„å…·ä½“ç”¨æ³•è§ README.md
            initWidget({
                waifuPath: tipsJsonPath,
                cdnPath: "https://cdn.jsdelivr.net/gh/SJTDreams/BlogModel@v0.0.1/",
                tools: ["hitokoto", "asteroids", "switch-model", "switch-texture", "photo", "info", "quit"]
            });
            initWaifuMouseEvent();
        });
    }
    function initWaifuMouseEvent() {
        const waifu = document.getElementById("waifu");
        let isDown = false;
        let waifuLeft;
        let mouseLeft;
        let waifuTop;
        let mouseTop;
        // é¼ æ ‡ç‚¹å‡»ç›‘å¬
        waifu.onmousedown = function (e) {
            isDown = true;
            // è®°å½•xè½´
            waifuLeft = waifu.offsetLeft;
            mouseLeft = e.clientX;
            // è®°å½•yè½´
            waifuTop = waifu.offsetTop;
            mouseTop = e.clientY;
        }
        // é¼ æ ‡ç§»åŠ¨ç›‘å¬
        window.onmousemove = function (e) {
            if (!isDown) {
                return;
            }
            // xè½´ç§»åŠ¨
            let currentLeft = waifuLeft + (e.clientX - mouseLeft);
            if (currentLeft < 0) {
                currentLeft = 0;
            } else if (currentLeft > window.innerWidth - 300) {
                currentLeft = window.innerWidth - 300;
            }
            waifu.style.left = currentLeft  + "px";
            // yè½´ç§»åŠ¨
            let currentTop = waifuTop + (e.clientY - mouseTop);
            if (currentTop < 30) {
                currentTop = 30
            } else if (currentTop > window.innerHeight - 290) {
                currentTop = window.innerHeight - 290
            }
            waifu.style.top = currentTop + "px";
        }
        // é¼ æ ‡ç‚¹å‡»æ¾å¼€ç›‘å¬
        window.onmouseup = function (e) {
            isDown = false;
        }
    }
</script>


<script>
    function showHideView() {
        // åˆ¤æ–­æ˜¯å¦å­˜åœ¨vercountæ ‡ç­¾
        let viewCounts = document.querySelectorAll("#viewCount");
        if (viewCounts) {
            // åˆ¤æ–­æ˜¯å¦ä¸ºæ–‡ç« é¡µ
            let article =  document.querySelector(".article-page");
            if (!article) {
                viewCounts.forEach(ele => {
                    ele.style.display = 'none';
                });
            }
        }
    }
    
    showHideView();
</script>

<script>
const staticDir = {{ .Site.Home.Permalink }}
const ap = new APlayer({
    container: document.getElementById('aplayer'),
    lrcType: 3,
    audio: [
        {
            
            name: 'å†¬ä¹‹é’ŸOST',
            artist: 'å¯¿å¸å‹‡è€…',
            url: staticDir + 'å†¬ä¹‹é’Ÿ.mp3',
            cover: staticDir + 'blacksouls.jpg',
            lrc: staticDir + 'lrc.lrc',
        },
        {
             name: 'ã€Remixã€‘èƒŒå›çš„çˆ±ä¸½ä¸', // æ­Œå
             artist: 'MYANSR', // æ­Œæ‰‹
             url: 'Alice.mp3', // æ­Œæ›²è·¯å¾„
             cover: 'blacksouls.jpg', // å°é¢è·¯å¾„
             lrc: 'lrc.lrc', // æ­Œè¯è·¯å¾„
        },
        {
             name: 'Are You Lost', // æ­Œå
             artist: 'park bird', // æ­Œæ‰‹
             url: 'Are You Lost.mp3', // æ­Œæ›²è·¯å¾„
             cover: 'lost.png', // å°é¢è·¯å¾„
             lrc: 'lrc.lrc', // æ­Œè¯è·¯å¾„
        },
        {
             name: 'Be Lost', // æ­Œå
             artist: 'è·¯ç°æ°”çƒz', // æ­Œæ‰‹
             url: 'Be Lost.mp3', // æ­Œæ›²è·¯å¾„
             cover: 'lost.png', // å°é¢è·¯å¾„
             lrc: 'lrc.lrc', // æ­Œè¯è·¯å¾„
        },
        {
             name: 'INTERNET YAMERO', // æ­Œå
             artist: 'KOTOKO', // æ­Œæ‰‹
             url: 'å‡å¤©.mp3', // æ­Œæ›²è·¯å¾„
             cover: 'fly.png', // å°é¢è·¯å¾„
             lrc: 'lrc.lrc', // æ­Œè¯è·¯å¾„
        },
        {
            
            name: 'å¤å…°æˆ˜bgm-blacksoulsII',
            artist: 'å¯¿å¸å‹‡è€…',
            url: staticDir + 'å¤å…°.mp3',
            cover: staticDir + 'blacksouls.jpg',
            lrc: staticDir + 'lrc.lrc',
        },
        {
            
            name: 'BlackSouls2 OST - ç‹©çŒé‚ªé¾™çš„æ²ƒæŸå°”',
            artist: 'å¯¿å¸å‹‡è€…',
            url: staticDir + 'é‚ªé¾™.mp3',
            cover: staticDir + 'blacksouls.jpg',
            lrc: staticDir + 'lrc.lrc',
        },
        {
            
            name: 'BlackSouls2 OST - åœ°ç‹±ç‹å­(å®‰å¾·çƒˆÂ·å¾·Â·æ´›å¾·)',
            artist: 'å¯¿å¸å‹‡è€…',
            url: staticDir + 'åœ°ç‹±ç‹å­.mp3',
            cover: staticDir + 'blacksouls.jpg',
            lrc: staticDir + 'lrc.lrc',
        },
        {
            
            name: 'BlackSouls2 OST - VSè™šæ— å°‘å¥³æ¢…è´å°” (Update Patch ver.)',
            artist: 'å¯¿å¸å‹‡è€…',
            url: staticDir + 'æ¢…è´å°”.mp3',
            cover: staticDir + 'blacksouls.jpg',
            lrc: staticDir + 'lrc.lrc',
        },
        {
            
            name: 'ã€Future Houseã€‘- Index',
            artist: 'Kirara Magic',
            url: staticDir + 'index.mp3',
            cover: staticDir + 'piara.jpg',
            lrc: staticDir + 'lrc.lrc',
        },
        {
            
            name: 'ğ•·ğ–†ğ–˜ğ–™ ğ•¯ğ–†ğ–“ğ–ˆğ–Š',
            artist: 'Xomu',
            url: staticDir + 'lastdance.mp3',
            cover: staticDir + 'last dance.jpg',
            lrc: staticDir + 'lrc.lrc',
        },
        {
            
            name: 'è™¹ã®è¶ï¼šSummer Pockets Original SoundTrack',
            artist: 'Key Sounds Label',
            url: staticDir + 'sp.mp3',
            cover: staticDir + 'sp.jpg',
            lrc: staticDir + 'lrc.lrc',
        }
        
    ]
});
window.onbeforeunload = () => {
        // å°†æ’­æ”¾ä¿¡æ¯ç”¨å¯¹è±¡å°è£…ï¼Œå¹¶å­˜å…¥åˆ°localStorageä¸­
        const playInfo = {
            index: ap.list.index,
            currentTime: ap.audio.currentTime,
            paused: ap.paused
        };
        localStorage.setItem("playInfo", JSON.stringify(playInfo));
    };
    /**
     * é¡µé¢åŠ è½½åç›‘å¬
     */
    window.onload = () => {
        // ä»localStorageå–å‡ºæ’­æ”¾ä¿¡æ¯
        const playInfo = JSON.parse(localStorage.getItem("playInfo"));
        if (!playInfo) {
            return;
        }
        // åˆ‡æ¢æ­Œæ›²
        ap.list.switch(playInfo.index);
        // ç­‰å¾…500mså†æ‰§è¡Œä¸‹ä¸€æ­¥(åˆ‡æ¢æ­Œæ›²éœ€è¦ç‚¹æ—¶é—´ï¼Œä¸èƒ½ç«‹é©¬è°ƒæ­Œæ›²è¿›åº¦æ¡)
        setTimeout(() => {
            // è°ƒæ•´æ—¶é•¿
            ap.seek(playInfo.currentTime);
            // æ˜¯å¦æ’­æ”¾
            if (!playInfo.paused) {
                ap.play()
            }
        }, 500);
    };

</script>
<script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script>
<script>
	var pjax = new Pjax({
	  selectors: [
	    ".main-container"
	  ]
	})
    pjax._handleResponse = pjax.handleResponse;
    pjax.handleResponse = function(responseText, request, href, options) {
        if (request.responseText.match("<html")) {
            // å°†æ–°é¡µé¢çš„htmlå­—ç¬¦ä¸²è§£ææˆDOMå¯¹è±¡
            let newDom = new DOMParser().parseFromString(responseText, 'text/html');
            // è·å–æ–°é¡µé¢ä¸­bodyçš„classNameï¼Œå¹¶è®¾ç½®å›å½“å‰é¡µé¢
            let bodyClass = newDom.body.className;
            document.body.setAttribute("class", bodyClass)
            // æ”¾è¡Œï¼Œäº¤ç»™pjaxè‡ªå·±å¤„ç†
            pjax._handleResponse(responseText, request, href, options);
        } else {
            // handle non-HTML response here
        }
    }
    document.addEventListener('pjax:complete', () => {
        // Stackè„šæœ¬åˆå§‹åŒ–
        window.Stack.init();
    })
</script>

